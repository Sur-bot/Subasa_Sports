<div class="review-wrapper">
  <h3 class="section-title">ÄÃ¡nh giÃ¡ sáº£n pháº©m</h3>

  <!-- Product Rating Summary - Enhanced -->
  <div class="rating-summary">
    <div class="rating-main">
      <!-- Left: Rating Score & Stars -->
      <div class="rating-score-box">
        <div class="rating-score-large">{{ averageRating || productRating || 0 }}</div>
        <div class="rating-stars-large">
          <span *ngFor="let s of [1,2,3,4,5]" class="star" [class.filled]="(averageRating || productRating) >= s">â˜…</span>
        </div>
        <div class="rating-meta">
          <span class="total-reviews">{{ totalReviews }} Ä‘Ã¡nh giÃ¡</span>
          <span class="product-rating" *ngIf="productRating > 0">(Sáº£n pháº©m: {{ productRating }}â˜…)</span>
        </div>
      </div>

      <!-- Right: Rating Distribution -->
      <div class="rating-distribution">
        <div class="rating-row" *ngFor="let stars of [5,4,3,2,1]">
          <span class="star-label">{{ stars }}â˜…</span>
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="getStarPercentage(stars)"></div>
          </div>
          <span class="count">{{ getStarCount(stars) }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Form gá»­i Ä‘Ã¡nh giÃ¡ -->
  <div class="review-form">
    <h4 class="form-title">Báº¡n Ä‘Ã£ mua sáº£n pháº©m nÃ y? HÃ£y chia sáº» cáº£m nháº­n!</h4>
    
    <div class="rating-row">
      <label class="rating-label">ÄÃ¡nh giÃ¡ cá»§a báº¡n:</label>
      <div class="stars" (mouseleave)="onStarLeave()">
        <span
          *ngFor="let s of [1,2,3,4,5]; let i = index"
          class="star interactive"
          [class.filled]="(hoverRating || rating) >= s"
          (mouseenter)="onStarEnter(s)"
          (click)="setRating(s)"
          role="button"
          aria-label="Chá»n {{s}} sao"
          >â˜…</span
        >
      </div>
      <div class="rating-note" *ngIf="rating">Báº¡n chá»n: <strong>{{ rating }} sao</strong></div>
    </div>

    <textarea
      [(ngModel)]="comment"
      placeholder="Chia sáº» tráº£i nghiá»‡m cá»§a báº¡n vá» sáº£n pháº©m nÃ y..."
      rows="4"
      class="comment-input"
      [disabled]="isSubmitting"
      maxlength="500"
    ></textarea>
    <div class="char-count">{{ comment.length }}/500</div>

    <div class="upload-row">
      <label class="upload-btn" [class.disabled]="isSubmitting">
        <input type="file" accept="image/*" multiple (change)="onFilesChange($event)" hidden [disabled]="isSubmitting" />
        ğŸ“· ChÃ¨n áº£nh ({{ images.length }}/{{ maxImages }})
      </label>
      <div class="image-previews">
        <div class="preview" *ngFor="let img of images; let idx = index">
          <img [src]="img" alt="preview" />
          <button class="remove" (click)="removeImage(idx)" title="XÃ³a áº£nh" [disabled]="isSubmitting">Ã—</button>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button class="btn-submit" (click)="submitReview()" [disabled]="isSubmitting || rating === 0">
        <span *ngIf="!isSubmitting">âœ“ Gá»­i Ä‘Ã¡nh giÃ¡</span>
        <span *ngIf="isSubmitting">â³ Äang gá»­i...</span>
      </button>
    </div>
  </div>

  <!-- Danh sÃ¡ch Ä‘Ã¡nh giÃ¡ -->
  <div class="reviews-list" *ngIf="reviews.length">
    <h4 class="sub-title">Nháº­n xÃ©t tá»« khÃ¡ch hÃ ng ({{ reviews.length }})</h4>
    
    <!-- Filter/Sort Options -->
    <div class="filter-options">
      <button class="filter-btn" *ngFor="let stars of [5,4,3,2,1]" 
        (click)="filterByRating(stars)"
        [class.active]="selectedRatingFilter === stars">
        {{ stars }}â˜… ({{ getStarCount(stars) }})
      </button>
      <button class="filter-btn" (click)="clearFilter()" [class.active]="selectedRatingFilter === 0">
        Táº¥t cáº£
      </button>
    </div>

    <!-- Reviews List -->
    <div class="review-item" *ngFor="let r of getFilteredReviews()">
      <div class="avatar">
        <img *ngIf="r.avatar" [src]="r.avatar" alt="{{ r.name }}" />
        <div *ngIf="!r.avatar" class="avatar-fallback">{{ r.name.charAt(0) || 'U' }}</div>
      </div>
      <div class="review-body">
        <div class="review-head">
          <div class="name-rating">
            <span class="name">{{ r.name }}</span>
            <span class="stars-inline">
              <span *ngFor="let s of [1,2,3,4,5]" class="star small" [class.filled]="r.rating >= s">â˜…</span>
            </span>
          </div>
          <div class="time">{{ timeAgo(r.createdAt) }} trÆ°á»›c</div>
        </div>
        <div class="comment">{{ r.comment }}</div>
        <div class="review-images" *ngIf="r.images && r.images.length">
          <img *ngFor="let im of r.images" [src]="im" alt="user-image" />
        </div>
      </div>
    </div>
  </div>

  <div class="no-reviews" *ngIf="!reviews.length && !isLoading">
    <p>ğŸ‘¥ ChÆ°a cÃ³ Ä‘Ã¡nh giÃ¡ nÃ o. HÃ£y lÃ  ngÆ°á»i Ä‘áº§u tiÃªn Ä‘Ã¡nh giÃ¡ sáº£n pháº©m nÃ y!</p>
  </div>

  <div class="loading" *ngIf="isLoading">
    <p>â³ Äang táº£i dá»¯ liá»‡u...</p>
  </div>
</div>