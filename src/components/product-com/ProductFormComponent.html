<div class="modal-backdrop" (click)="close.emit()"></div>

<div class="modal">
  <h2>{{ product.id ? 'Chỉnh sửa sản phẩm' : 'Tạo sản phẩm mới' }}</h2>

  <form (ngSubmit)="saveProduct()" *ngIf="!loading; else loadingTpl">
    <!-- Dropdown chọn sản phẩm -->
    <div *ngIf="productList.length > 0" class="form-group">
      <label>Chọn sản phẩm</label>
      <select [ngModel]="product.id" (ngModelChange)="selectProduct($event)" name="productSelect">
        <option value="">-- Tạo sản phẩm mới --</option>
        <option *ngFor="let p of productList" [value]="p.id">
          {{ p.productName }} - {{ p.price | currency:'VND':'symbol':'1.0-0' }}
        </option>
      </select>
    </div>

    <!-- Tên sản phẩm -->
    <div class="form-group">
      <label>Tên sản phẩm</label>
      <input type="text" [(ngModel)]="product.productName" name="productName" required />
    </div>

    <!-- Mô tả -->
    <div class="form-group">
      <label>Mô tả</label>
      <textarea [(ngModel)]="product.description" name="description"></textarea>
    </div>

    <!-- Giá -->
    <div class="form-group">
      <label>Giá</label>
      <input type="number" [(ngModel)]="product.price" name="price" required />
    </div>

    <!-- Chọn size (nếu category có size) -->
    <div class="form-group" *ngIf="selectedCategoryObj?.hasSize">
      <label>Chọn size</label>
      <div class="size-selector">
        <button type="button"
          *ngFor="let s of availableSizes"
          [class.active]="isSelected(s)"
          (click)="toggleSize(s)">
          {{ s }}
        </button>
      </div>
    </div>

    <!-- Input số lượng cho size (nếu có size) -->
    <div class="form-group" *ngIf="selectedCategoryObj?.hasSize">
      <div *ngFor="let s of product.sizes; let i = index">
        <label>Size {{ s.size }}</label>
        <input type="number" [(ngModel)]="product.sizes[i].quantity" name="quantity-{{s.size}}" min="1" />
      </div>
    </div>

    <!-- Nếu KHÔNG có size (accessorys, v.v.) -->
    <div class="form-group" *ngIf="selectedCategoryObj && !selectedCategoryObj.hasSize">
      <label>Số lượng</label>
      <input type="number" [(ngModel)]="product.quantity" name="quantity" min="1" />
    </div>

    <!-- Category -->
    <div class="form-group">
      <label>Danh mục</label>
      <select [(ngModel)]="selectedCategory" name="category" (ngModelChange)="onCategoryChange($event)">
        <option value="">-- Chọn danh mục --</option>
        <option *ngFor="let c of categories" [value]="c.id">{{ c.name }}</option>
      </select>
    </div>

    <!-- Brand -->
    <div class="form-group" *ngIf="brands.length > 0">
      <label>Thương hiệu</label>
      <select [(ngModel)]="product.brand" name="brand">
        <option value="">-- Chọn thương hiệu --</option>
        <option *ngFor="let b of brands" [value]="b.id">{{ b.name }}</option>
      </select>
    </div>

    <!-- Giảm giá -->
    <div class="form-group">
      <label>Giảm giá (%)</label>
      <input type="number" [(ngModel)]="product.discount" name="discount" min="0" max="100"/>
    </div>

    <!-- Upload ảnh -->
    <div class="form-group">
      <label>Ảnh sản phẩm</label>
      <input type="file" multiple (change)="onFileSelected($event)" />
      <div class="preview">
        <img *ngFor="let f of selectedFiles" [src]="getPreviewUrl(f)" />
        <ng-container *ngIf="!selectedFiles.length">
          <img *ngFor="let img of product.productImage" [src]="img" />
        </ng-container>
      </div>
    </div>

    <!-- Action buttons -->
    <div class="actions">
      <button type="submit" [disabled]="loading">
        {{ product.id ? 'Cập nhật' : 'Tạo mới' }}
      </button>
      <button *ngIf="product.id" type="button" class="delete-btn" (click)="deleteProduct()" [disabled]="loading">
        Xóa
      </button>
      <button type="button" (click)="close.emit()">Đóng</button>
    </div>
  </form>

  <ng-template #loadingTpl>
    <p>Đang xử lý, vui lòng chờ...</p>
  </ng-template>
</div>