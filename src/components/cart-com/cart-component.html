<ng-container *ngIf="vm$ | async as vm">
  <!-- Giá» hÃ ng button + dropdown -->
  <div class="cart-container">
    <a routerLink="/cart" class="cart-button" title="Giá» hÃ ng">
      <div class="cart-icon-wrapper">
        <svg class="cart-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
          <path fill="currentColor"
            d="M96 0C107.5 0 118.1 4.3 126.7 12.1L193.3 80H480c26.5 0 48 21.5 48 48V352c0 26.5-21.5 48-48 48H176c-13.2 0-25-5.3-34-14.3L8 160V48c0-26.5 21.5-48 48-48H96zM152 464c0 17.7 14.3 32 32 32s32-14.3 32-32c0-17.7-14.3-32-32-32s-32 14.3-32 32zm256 0c0 17.7 14.3 32 32 32s32-14.3 32-32c0-17.7-14.3-32-32-32s-32 14.3-32 32z" />
        </svg>
        <span class="cart-badge">{{ vm.totalItems }}</span>
      </div>
      <span class="cart-text">Giá» hÃ ng</span>
    </a>

    <div class="cart-dropdown">
      <div class="dropdown-header">
        <h4>Giá» hÃ ng cá»§a báº¡n ({{ vm.totalItems }} sáº£n pháº©m)</h4>
        <button class="btn-history" (click)="openOrderHistory()">ÄÆ¡n hÃ ng Ä‘Ã£ mua</button>
        <button *ngIf="isSeller" class="btn-seller" (click)="openSellerOrders()">Quáº£n lÃ½ Ä‘Æ¡n hÃ ng</button>
      </div>

      <div *ngIf="vm.totalItems === 0" class="empty-cart">
        <p>Giá» hÃ ng trá»‘ng! HÃ£y thÃªm sáº£n pháº©m nhÃ©.</p>
      </div>

      <div *ngIf="vm.totalItems > 0" class="dropdown-items">
        <div *ngFor="let item of vm.items" class="item-example">
          <img [src]="item.product.imageUrl" [alt]="item.product.productName" class="item-thumb">
          <div class="item-info">
            <p class="item-name">{{ item.product.productName }}</p>
            <small *ngIf="item.selectedSize !== 'Máº·c Ä‘á»‹nh'">Size: {{ item.selectedSize }}</small>
            <small *ngIf="item.selectedColor !== 'Máº·c Ä‘á»‹nh'"> | MÃ u: {{ item.selectedColor }}</small>
            <div class="quantity-controls">
              <button (mousedown)="startChangingQuantity(item, -1)" (mouseup)="stopChangingQuantity()"
                (mouseleave)="stopChangingQuantity()" class="btn-qty" [disabled]="item.quantity <= 1">-</button>
              <input type="number" class="qty-input" [value]="item.quantity"
                (change)="onManualQuantityChange($event, item)" min="1" [max]="getMaxStock(item)">
              <button (mousedown)="startChangingQuantity(item, 1)" (mouseup)="stopChangingQuantity()"
                (mouseleave)="stopChangingQuantity()" class="btn-qty"
                [disabled]="item.quantity >= getMaxStock(item)">+</button>
            </div>
          </div>
          <button (click)="cartService.removeFromCart(item.uniqueId)" class="btn-remove" title="XÃ³a sáº£n pháº©m">Ã—</button>
        </div>
      </div>

      <div *ngIf="vm.totalItems > 0" class="dropdown-footer">
        <div class="total-row">
          <span>Tá»•ng cá»™ng:</span>
          <span class="total-price">{{ vm.totalPrice | number:'1.0-0' }}â‚«</span>
        </div>
        <button (click)="onProceedToCheckout()" class="btn-view-cart">Thanh toÃ¡n ngay</button>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <app-checkout-modal
  *ngIf="isCheckoutModalVisible"
  (closeModal)="isCheckoutModalVisible = false">
</app-checkout-modal>

<div class="login-modal-overlay" *ngIf="isLoginRequestVisible" (click)="isLoginRequestVisible = false">
  <div class="login-modal-content" (click)="$event.stopPropagation()">
    
    <div class="login-icon">ğŸ”’</div>
    <h3>Vui lÃ²ng Ä‘Äƒng nháº­p</h3>
    <p>Báº¡n cáº§n Ä‘Äƒng nháº­p tÃ i khoáº£n thÃ nh viÃªn Ä‘á»ƒ tiáº¿p tá»¥c thanh toÃ¡n vÃ  tÃ­ch Ä‘iá»ƒm.</p>
    
    <div class="login-actions">
      <button class="btn-cancel" (click)="isLoginRequestVisible = false">Äá»ƒ sau</button>
      <button class="btn-login" (click)="goToLogin()">ÄÄƒng nháº­p ngay</button>
    </div>

  </div>
</div>

  <!-- Buyer Order History Popup -->
  <div class="order-history-popup" *ngIf="isOrderHistoryVisible">
    <div class="popup-header">
      <h3>ÄÆ¡n hÃ ng Ä‘Ã£ mua</h3>
      <button (click)="closeOrderHistory()">Ã—</button>
    </div>
    <div class="popup-body">
      <ng-container *ngFor="let status of orderStatuses">
        <ng-container *ngIf="getOrdersByStatus(status).length > 0">
          <h4 *ngIf="status==='pending'">Äang chá» (Pending)</h4>
          <h4 *ngIf="status==='shipping'">Äang giao (Shipping)</h4>
          <h4 *ngIf="status==='delivered'">ÄÃ£ giao (Delivered)</h4>
          <h4 *ngIf="status==='cancel'">ÄÃ£ há»§y (Cancel)</h4>

          <div *ngFor="let order of getOrdersByStatus(status)" class="order-item">
            <p><strong>MÃ£ Ä‘Æ¡n:</strong> {{ order.orderId }}</p>
            <p><strong>NgÃ y:</strong> {{ order.createdAt.toDate() | date:'short' }}</p>
            <p><strong>Tá»•ng tiá»n:</strong> {{ order.totalPrice | number:'1.0-0' }}â‚«</p>
            <p><strong>Tráº¡ng thÃ¡i:</strong> {{ order.status }}</p>
            <div *ngFor="let item of order.items" class="order-product">
              <img [src]="item.imageUrl" alt="{{ item.name }}" class="thumb">
              <span>{{ item.name }} x {{ item.quantity }}</span>
              <span>{{ item.price | number:'1.0-0' }}â‚«</span>
            </div>
            <hr>
          </div>
        </ng-container>
      </ng-container>
    </div>
  </div>

  <!-- Seller Order Management Popup -->
  <div class="order-history-popup" *ngIf="isSellerPopupVisible">
    <div class="popup-header">
      <h3>Quáº£n lÃ½ Ä‘Æ¡n hÃ ng (Seller)</h3>
      <button (click)="closeSellerOrders()">Ã—</button>
    </div>
    <div class="popup-body">
      <div *ngIf="sellerOrders.length === 0" class="empty-status">
        ChÆ°a cÃ³ Ä‘Æ¡n hÃ ng nÃ o.
      </div>

      <div *ngFor="let order of sellerOrders" class="order-item">
        <p><strong>MÃ£ Ä‘Æ¡n:</strong> {{ order.orderId }}</p>
        <p><strong>TÃ i khoáº£n Ä‘áº·t hÃ ng:</strong> {{ order.userEmail }}</p>
        <p><strong>NgÆ°á»i nháº­n:</strong> {{ order.customerName }}</p>
        <p><strong>Äá»‹a chá»‰:</strong> {{ order.customerAddress }}</p>
        <p><strong>Sá»‘ Ä‘iá»‡n thoáº¡i:</strong> {{ order.customerPhone }}</p>
        <p><strong>NgÃ y:</strong> {{ order.createdAt.toDate() | date:'short' }}</p>
        <p><strong>Tráº¡ng thÃ¡i:</strong> {{ order.status }}</p>

        <div *ngFor="let item of order.items" class="order-product">
          <img [src]="item.imageUrl" alt="{{ item.name }}" class="thumb">
          <span>{{ item.name }} x {{ item.quantity }}</span>
          <span>{{ item.price | number:'1.0-0' }}â‚«</span>
        </div>

        <!-- NÃºt cáº­p nháº­t tráº¡ng thÃ¡i theo tráº¡ng thÃ¡i hiá»‡n táº¡i -->
        <div class="order-actions">
          <button *ngIf="order.status==='pending'" class="status-btn pending" (click)="updateOrderStatus(order)">
            XÃ¡c nháº­n gá»­i hÃ ng
          </button>

          <button *ngIf="order.status==='shipping'" class="status-btn shipping" (click)="updateOrderStatus(order)">
            ÄÃ£ giao thÃ nh cÃ´ng
          </button>

          <button *ngIf="order.status==='delivered' || order.status==='cancel'" class="status-btn disabled" disabled>
            {{ order.status === 'delivered' ? 'ÄÃ£ giao' : 'ÄÃ£ há»§y' }}
          </button>
        </div>
        <hr>
      </div>
    </div>
  </div>

</ng-container>