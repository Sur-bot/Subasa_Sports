<ng-container *ngIf="vm$ | async as vm">
  <!-- Giá» hÃ ng button + dropdown -->
  <div class="cart-container">
    <a routerLink="/cart" class="cart-button" title="Giá» hÃ ng">
      <div class="cart-icon-wrapper">
        <svg class="cart-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
          <path fill="currentColor"
            d="M96 0C107.5 0 118.1 4.3 126.7 12.1L193.3 80H480c26.5 0 48 21.5 48 48V352c0 26.5-21.5 48-48 48H176c-13.2 0-25-5.3-34-14.3L8 160V48c0-26.5 21.5-48 48-48H96zM152 464c0 17.7 14.3 32 32 32s32-14.3 32-32c0-17.7-14.3-32-32-32s-32 14.3-32 32zm256 0c0 17.7 14.3 32 32 32s32-14.3 32-32c0-17.7-14.3-32-32-32s-32 14.3-32 32z" />
        </svg>
        <span class="cart-badge">{{ vm.totalItems }}</span>
      </div>
      <span class="cart-text">Giá» hÃ ng</span>
    </a>

    <div class="cart-dropdown">
      <div class="dropdown-header">
        <h4>Giá» hÃ ng cá»§a báº¡n ({{ vm.totalItems }} sáº£n pháº©m)</h4>
      </div>

      <div *ngIf="vm.totalItems === 0" class="empty-cart">
        <p>Giá» hÃ ng trá»‘ng! HÃ£y thÃªm sáº£n pháº©m nhÃ©.</p>
      </div>

      <div *ngIf="vm.totalItems > 0" class="dropdown-items">
        <div *ngFor="let item of vm.items" class="item-example">
          <img [src]="item.product.imageUrl" [alt]="item.product.productName" class="item-thumb">
          <div class="item-info">
            <p class="item-name">{{ item.product.productName }}</p>
            <small *ngIf="item.selectedSize !== 'Máº·c Ä‘á»‹nh'">Size: {{ item.selectedSize }}</small>
            <!-- <small *ngIf="item.selectedColor !== 'Máº·c Ä‘á»‹nh'"> | MÃ u: {{ item.selectedColor }}</small> -->
            <div class="quantity-controls">
              <button (mousedown)="startChangingQuantity(item, -1)" (mouseup)="stopChangingQuantity()"
                (mouseleave)="stopChangingQuantity()" class="btn-qty" [disabled]="item.quantity <= 1">-</button>
              <input type="number" class="qty-input" [value]="item.quantity"
                (change)="onManualQuantityChange($event, item)" min="1" [max]="getMaxStock(item)">
              <button (mousedown)="startChangingQuantity(item, 1)" (mouseup)="stopChangingQuantity()"
                (mouseleave)="stopChangingQuantity()" class="btn-qty"
                [disabled]="item.quantity >= getMaxStock(item)">+</button>
            </div>
          </div>
          <button (click)="cartService.removeFromCart(item.uniqueId)" class="btn-remove" title="XÃ³a sáº£n pháº©m">Ã—</button>
        </div>
      </div>

      <div class="dropdown-footer">

        <div *ngIf="vm.totalItems > 0" class="total-row">
          <span>Tá»•ng cá»™ng:</span>
          <span class="total-price">{{ vm.totalPrice | number:'1.0-0' }}â‚«</span>
        </div>

        <div class="footer-buttons">
          <button class="btn-view-cart" (click)="openOrderHistory()">ÄÆ¡n hÃ ng Ä‘Ã£ mua</button>

          <button *ngIf="vm.totalItems > 0" (click)="onProceedToCheckout()" class="btn-view-cart">Thanh toÃ¡n
            ngay</button>
        </div>

        <button *ngIf="isSeller" class="btn-view-seller" (click)="openSellerOrders()">Quáº£n lÃ½ Ä‘Æ¡n hÃ ng</button>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <app-checkout-modal
  *ngIf="isCheckoutModalVisible"
  (closeModal)="isCheckoutModalVisible = false">
</app-checkout-modal>

  <div class="login-modal-overlay" *ngIf="isLoginRequestVisible" (click)="isLoginRequestVisible = false">
    <div class="login-modal-content" (click)="$event.stopPropagation()">

      <div class="login-icon">ğŸ”’</div>
      <h3>Vui lÃ²ng Ä‘Äƒng nháº­p</h3>
      <p>Báº¡n cáº§n Ä‘Äƒng nháº­p tÃ i khoáº£n thÃ nh viÃªn Ä‘á»ƒ tiáº¿p tá»¥c thanh toÃ¡n vÃ  tÃ­ch Ä‘iá»ƒm.</p>

      <div class="login-actions">
        <button class="btn-cancel" (click)="isLoginRequestVisible = false">Äá»ƒ sau</button>
        <button class="btn-login" (click)="goToLogin()">ÄÄƒng nháº­p ngay</button>
      </div>

    </div>
  </div>

  <!-- Buyer Order History Popup -->
<div class="order-history-popup" *ngIf="isOrderHistoryVisible">
  <div class="popup-header">
    <h3>ÄÆ¡n hÃ ng Ä‘Ã£ mua</h3>
    <button (click)="closeOrderHistory()">Ã—</button>
  </div>

  <!-- FILTER TABS -->
  <div class="order-tabs">
    <button
      *ngFor="let tab of orderTabs"
      (click)="activeTab = tab.key"
      [class.active]="activeTab === tab.key">
      {{ tab.label }}
    </button>
  </div>

  <!-- ORDER LIST -->
  <div class="popup-body">
    <div *ngFor="let order of filteredOrders()" class="order-item">
      <p><strong>MÃ£ Ä‘Æ¡n:</strong> {{ order.orderId }}</p>
      <p><strong>NgÃ y:</strong> {{ order.createdAt.toDate() | date:'short' }}</p>
      <p><strong>Tá»•ng tiá»n:</strong> {{ order.totalPrice | number:'1.0-0' }}â‚«</p>
      <p><strong>Tráº¡ng thÃ¡i:</strong> {{ order.status }}</p>

      <div *ngFor="let item of order.items" class="order-product">
        <img [src]="item.imageUrl" alt="{{ item.name }}" class="thumb">
        <span>{{ item.name }} x {{ item.quantity }}</span>
        <span>{{ item.price | number:'1.0-0' }}â‚«</span>
      </div>

      <hr>
    </div>
  </div>
</div>


 <!-- Seller Order Management Popup -->
<div class="order-history-popup" *ngIf="isSellerPopupVisible">

  <div class="popup-header">
    <h3>QUáº¢N LÃ ÄÆ N HÃ€NG</h3>
    <button (click)="closeSellerOrders()">Ã—</button>
  </div>

  <!-- TAB HEADER -->
  <div class="tab-header">
    <button [class.active]="currentSellerTab === 'all'" (click)="setSellerTab('all')">Táº¥t cáº£</button>
    <button [class.active]="currentSellerTab === 'pending'" (click)="setSellerTab('pending')">Äang chá»</button>
    <button [class.active]="currentSellerTab === 'shipping'" (click)="setSellerTab('shipping')">Äang váº­n chuyá»ƒn</button>
    <button [class.active]="currentSellerTab === 'delivered'" (click)="setSellerTab('delivered')">ÄÃ£ giao</button>
    <button [class.active]="currentSellerTab === 'cancel'" (click)="setSellerTab('cancel')">ÄÃ£ há»§y</button>
  </div>

  <div class="popup-body">
    <div *ngIf="getSellerOrdersByStatus(currentSellerTab).length === 0" class="empty-status">
      KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng nÃ o.
    </div>

    <div *ngFor="let order of getSellerOrdersByStatus(currentSellerTab)" class="order-item">

      <p><strong>MÃ£ Ä‘Æ¡n:</strong> {{ order.orderId }}</p>
      <p><strong>TÃ i khoáº£n Ä‘áº·t hÃ ng:</strong> {{ order.userEmail }}</p>
      <p><strong>NgÆ°á»i nháº­n:</strong> {{ order.customerName }}</p>
      <p><strong>Äá»‹a chá»‰:</strong> {{ order.customerAddress }}</p>
      <p><strong>Sá»‘ Ä‘iá»‡n thoáº¡i:</strong> {{ order.customerPhone }}</p>
      <p><strong>NgÃ y:</strong> {{ order.createdAt.toDate() | date:'short' }}</p>
      <p><strong>Tráº¡ng thÃ¡i:</strong> {{ order.status }}</p>

      <div *ngFor="let item of order.items" class="order-product">
        <img [src]="item.imageUrl" alt="{{ item.name }}" class="thumb">
        <span>{{ item.name }} x {{ item.quantity }}</span>
        <span>{{ item.price | number:'1.0-0' }}â‚«</span>
      </div>

      <!-- ACTION BUTTONS -->
      <div class="order-actions">
        <button *ngIf="order.status==='pending'" class="status-btn" (click)="updateOrderStatus(order)">
          XÃC NHáº¬N Gá»¬I HÃ€NG
        </button>

        <button *ngIf="order.status==='shipping'" class="status-btn" (click)="updateOrderStatus(order)">
          ÄÃƒ GIAO THÃ€NH CÃ”NG
        </button>

        <button *ngIf="order.status==='delivered' || order.status==='cancel'" class="status-btn-disable" disabled>
          {{ order.status === 'delivered' ? 'ÄÃƒ GIAO' : 'ÄÃƒ Há»¦Y' }}
        </button>
      </div>

      <div>
        <button class="btn-cancel-order" (click)="cancelOrder(order)"
          *ngIf="order.status !== 'cancel' && order.status !== 'delivered'">
          Há»¦Y ÄÆ N HÃ€NG
        </button>
      </div>

    </div>
  </div>
</div>


</ng-container>