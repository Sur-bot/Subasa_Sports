<ng-container *ngIf="vm$ | async as vm">
  <!-- Giỏ hàng button + dropdown -->
  <div class="cart-container">
    <a routerLink="/cart" class="cart-button" title="Giỏ hàng">
      <div class="cart-icon-wrapper">
        <svg class="cart-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
          <path fill="currentColor"
            d="M96 0C107.5 0 118.1 4.3 126.7 12.1L193.3 80H480c26.5 0 48 21.5 48 48V352c0 26.5-21.5 48-48 48H176c-13.2 0-25-5.3-34-14.3L8 160V48c0-26.5 21.5-48 48-48H96zM152 464c0 17.7 14.3 32 32 32s32-14.3 32-32c0-17.7-14.3-32-32-32s-32 14.3-32 32zm256 0c0 17.7 14.3 32 32 32s32-14.3 32-32c0-17.7-14.3-32-32-32s-32 14.3-32 32z" />
        </svg>
        <span class="cart-badge">{{ vm.totalItems }}</span>
      </div>
      <span class="cart-text">Giỏ hàng</span>
    </a>

    <div class="cart-dropdown">
      <div class="dropdown-header">
        <h4>Giỏ hàng của bạn ({{ vm.totalItems }} sản phẩm)</h4>
        <button class="btn-history" (click)="openOrderHistory()">Đơn hàng đã mua</button>
        <button *ngIf="isSeller" class="btn-seller" (click)="openSellerOrders()">Quản lý đơn hàng</button>
      </div>

      <div *ngIf="vm.totalItems === 0" class="empty-cart">
        <p>Giỏ hàng trống! Hãy thêm sản phẩm nhé.</p>
      </div>

      <div *ngIf="vm.totalItems > 0" class="dropdown-items">
        <div *ngFor="let item of vm.items" class="item-example">
          <img [src]="item.product.imageUrl" [alt]="item.product.productName" class="item-thumb">
          <div class="item-info">
            <p class="item-name">{{ item.product.productName }}</p>
            <small *ngIf="item.selectedSize !== 'Mặc định'">Size: {{ item.selectedSize }}</small>
            <small *ngIf="item.selectedColor !== 'Mặc định'"> | Màu: {{ item.selectedColor }}</small>
            <div class="quantity-controls">
              <button (mousedown)="startChangingQuantity(item, -1)" (mouseup)="stopChangingQuantity()"
                (mouseleave)="stopChangingQuantity()" class="btn-qty" [disabled]="item.quantity <= 1">-</button>
              <input type="number" class="qty-input" [value]="item.quantity"
                (change)="onManualQuantityChange($event, item)" min="1" [max]="getMaxStock(item)">
              <button (mousedown)="startChangingQuantity(item, 1)" (mouseup)="stopChangingQuantity()"
                (mouseleave)="stopChangingQuantity()" class="btn-qty"
                [disabled]="item.quantity >= getMaxStock(item)">+</button>
            </div>
          </div>
          <button (click)="cartService.removeFromCart(item.uniqueId)" class="btn-remove" title="Xóa sản phẩm">×</button>
        </div>
      </div>

      <div *ngIf="vm.totalItems > 0" class="dropdown-footer">
        <div class="total-row">
          <span>Tổng cộng:</span>
          <span class="total-price">{{ vm.totalPrice | number:'1.0-0' }}₫</span>
        </div>
        <button (click)="isCheckoutModalVisible = true" class="btn-view-cart">Thanh toán ngay</button>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <app-checkout-modal *ngIf="isCheckoutModalVisible" (closeModal)="isCheckoutModalVisible = false"></app-checkout-modal>

  <!-- Buyer Order History Popup -->
  <div class="order-history-popup" *ngIf="isOrderHistoryVisible">
    <div class="popup-header">
      <h3>Đơn hàng đã mua</h3>
      <button (click)="closeOrderHistory()">×</button>
    </div>
    <div class="popup-body">
      <ng-container *ngFor="let status of orderStatuses">
        <ng-container *ngIf="getOrdersByStatus(status).length > 0">
          <h4 *ngIf="status==='pending'">Đang chờ (Pending)</h4>
          <h4 *ngIf="status==='shipping'">Đang giao (Shipping)</h4>
          <h4 *ngIf="status==='delivered'">Đã giao (Delivered)</h4>
          <h4 *ngIf="status==='cancel'">Đã hủy (Cancel)</h4>

          <div *ngFor="let order of getOrdersByStatus(status)" class="order-item">
            <p><strong>Mã đơn:</strong> {{ order.orderId }}</p>
            <p><strong>Ngày:</strong> {{ order.createdAt.toDate() | date:'short' }}</p>
            <p><strong>Tổng tiền:</strong> {{ order.totalPrice | number:'1.0-0' }}₫</p>
            <p><strong>Trạng thái:</strong> {{ order.status }}</p>
            <div *ngFor="let item of order.items" class="order-product">
              <img [src]="item.imageUrl" alt="{{ item.name }}" class="thumb">
              <span>{{ item.name }} x {{ item.quantity }}</span>
              <span>{{ item.price | number:'1.0-0' }}₫</span>
            </div>
            <hr>
          </div>
        </ng-container>
      </ng-container>
    </div>
  </div>

  <!-- Seller Order Management Popup -->
  <div class="order-history-popup" *ngIf="isSellerPopupVisible">
    <div class="popup-header">
      <h3>Quản lý đơn hàng (Seller)</h3>
      <button (click)="closeSellerOrders()">×</button>
    </div>
    <div class="popup-body">
      <div *ngIf="sellerOrders.length === 0" class="empty-status">
        Chưa có đơn hàng nào.
      </div>

      <div *ngFor="let order of sellerOrders" class="order-item">
        <p><strong>Mã đơn:</strong> {{ order.orderId }}</p>
        <p><strong>Tài khoản đặt hàng:</strong> {{ order.userEmail }}</p>
        <p><strong>Người nhận:</strong> {{ order.customerName }}</p>
        <p><strong>Địa chỉ:</strong> {{ order.customerAddress }}</p>
        <p><strong>Số điện thoại:</strong> {{ order.customerPhone }}</p>
        <p><strong>Ngày:</strong> {{ order.createdAt.toDate() | date:'short' }}</p>
        <p><strong>Trạng thái:</strong> {{ order.status }}</p>

        <div *ngFor="let item of order.items" class="order-product">
          <img [src]="item.imageUrl" alt="{{ item.name }}" class="thumb">
          <span>{{ item.name }} x {{ item.quantity }}</span>
          <span>{{ item.price | number:'1.0-0' }}₫</span>
        </div>

        <!-- Nút cập nhật trạng thái theo trạng thái hiện tại -->
        <div class="order-actions">
          <button *ngIf="order.status==='pending'" class="status-btn pending" (click)="updateOrderStatus(order)">
            Xác nhận gửi hàng
          </button>

          <button *ngIf="order.status==='shipping'" class="status-btn shipping" (click)="updateOrderStatus(order)">
            Đã giao thành công
          </button>

          <button *ngIf="order.status==='delivered' || order.status==='cancel'" class="status-btn disabled" disabled>
            {{ order.status === 'delivered' ? 'Đã giao' : 'Đã hủy' }}
          </button>
        </div>
        <hr>
      </div>
    </div>
  </div>

</ng-container>