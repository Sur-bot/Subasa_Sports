<div class="modal-overlay" (click)="onClose()">
  <div class="modal-content" (click)="$event.stopPropagation()">

    <button class="close-button" (click)="onClose()">X</button>

    <div class="modal-main-content">
      <div class="product-image-column">
        <img [src]="product.imageUrl" [alt]="product.productName" class="modal-main-image">
      </div>

      <div class="product-options-column">
        
        <div class="modal-header-details">
          <h3 class="product-name">SẢN PHẨM {{ product.productName }}</h3>
          <div class="price-details">
            <span class="sale-price">{{ product.salePrice | number:'1.0-0' }}₫</span>
            <span class="original-price">{{ product.originalPrice | number:'1.0-0' }}₫</span>
          </div>
        </div>

        <div class="modal-body-options">

          @if (product.colors && product.colors.length > 0) {
            <div class="option-group color-select">
              <h4 class="option-title">Màu sắc:</h4>
              <div class="option-list color-options">
                @for (color of product.colors; track color.hexCode) {
                  <div class="color-dot" 
                       [style.backgroundColor]="color.hexCode"
                       (click)="selectColor(color.hexCode)" 
                       [class.selected]="selectedColor === color.hexCode">
                  </div>
                }
              </div>
            </div>
          }

          @if (product.hasSize) {
            <div class="option-group size-select">
              <h4 class="option-title">Kích thước:</h4>
              <div class="option-list size-options">
                @for (option of availableSizeOptions; track option.size) {
                  <button class="size-button" 
                    (click)="selectSize(option.size)"
                    [class.selected]="selectedSize === String(option.size)"
                    [disabled]="(option.quantity || 0) <= 0"
                    [class.out-of-stock]="(option.quantity || 0) <= 0">
                    {{ option.size }}
                  </button>
                } @empty {
                  <span class="no-size-available">Sản phẩm đã hết hàng.</span>
                }
              </div>
            </div>
          }

          <div class="stock-message-area">
            @if (product.hasSize) {
              @if (selectedSize) {
                @if (maxQuantity > 0) {
                  <p class="stock-info">Còn lại: {{ maxQuantity }} sản phẩm (Size {{ selectedSize }})</p>
                } @else {
                  <p class="stock-info text-danger">Sản phẩm tạm hết hàng</p>
                }
              } @else if (availableSizeOptions.length > 0) {
                <p class="stock-info select-size-prompt">Vui lòng chọn kích thước.</p>
              }
            } @else {
              @if (maxQuantity > 0) {
                <p class="stock-info">Còn lại: {{ maxQuantity }} sản phẩm</p>
              } @else {
                <p class="stock-info text-danger">Sản phẩm đã hết hàng</p>
              }
            }
          </div>
          @if (errorMessage) {
            <div class="error-message">{{ errorMessage }}</div>
          }
        </div>
      </div>
    </div>

    <div class="modal-footer-controls">
      <div class="quantity-control-wrapper">
        
        <button class="qty-btn" 
          (mousedown)="startChanging(-1)" 
          (mouseup)="stopChanging()" 
          (mouseleave)="stopChanging()"
          [disabled]="selectedQuantity <= 1 || maxQuantity === 0">
          -
        </button>

        <input 
          type="number" 
          class="quantity-input" 
          [value]="selectedQuantity" 
          (change)="onManualQuantityChange($event)"
          min="1"
          [max]="maxQuantity"
          [disabled]="maxQuantity === 0"
        >

        <button class="qty-btn" 
          (mousedown)="startChanging(1)" 
          (mouseup)="stopChanging()" 
          (mouseleave)="stopChanging()"
          [disabled]="selectedQuantity >= maxQuantity || maxQuantity === 0">
          +
        </button>

      </div>

      <button class="add-to-cart-button" 
              (click)="addToCart()" 
              [disabled]="maxQuantity === 0 || (product.hasSize && !selectedSize)">
        Thêm vào giỏ hàng
      </button>
    </div>

  </div>
</div>